<title>Monkeytype Clone - Test your typing skills</title>
<style>
    :root{
        color-scheme: light dark;
        --chillyred: #d64933;
        --ashgrey: #bac1b8;
        --moonstone: #58a4b0;
        --darkgreen: #0c7c59;
        --gunmetal: #2b303A;
    }

    body{
        font-family: 'Courier New', monospace;
        background: var(--gunmetal);
        display: grid;
        justify-content: center;
        margin-top: 32px;
        padding: 16px;
    }

    section{
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 6px;
    max-width: 500px;
    }

    time{
    color: var(--darkgreen);
    }

    input{
    z-index: -999;
    position: absolute;
    top: 0;
    left: 0;
    pointer-events: none;
    opacity: 0;
    }

    P{
    display: flex;
    flex-wrap: wrap;
    gap: 3px 9px;
    margin: 0;
    }

    x-letter{
    color:var(--ashgrey);
    position: relative;

    &.active::before {
        content: '|';
        color: var(--darkgreen);
        font-size: 14px;
        position: absolute;
        left: -65%;
        animation: 1s blink infinite ease-in-out;
    }

    &.is-last::before{
        left: 65%;
    }

    &.correct {
        color: var(--moonstone);
    }

    &.incorrect {
        color: var(--chillyred);
    }
    }

    x-word{
    border-bottom: 1px solid transparent;
    transition: border-color 0.3 ease-in-out;

    &.marked{
        border-color:var(--chillyred);
    }
    }

    @keyframes blink {
    0%, 25% { 
        opacity: 1;
    }
    75% {
        opacity: 0;
    }
    }

    #game{
    display: flex;
    }

    #results{
    display: none;
    }

</style>

<body>
    <main>
    <section id="game">
        <time></time>
        <p></p>
        <input autofocus />
    </section>
    <section id="results">
        <h2>wpm</h2>
        <h3></h3>

        <h2>accuracy</h2>
        <h3></h3>
    </section>
    </main>
</body>

<script type="module">
    import { words as INITAL_WORDS } from "./data.js"


    const $time = document.querySelector("time");
    const $paragraph = document.querySelector("p");
    const $input = document.querySelector("input");

    const INITIAL_TIME = 30;

    let words = []
    let currentTime = INITIAL_TIME

    initGame()
    initEvents()

    function initGame() {
        words = INITAL_WORDS.toSorted(
            () => Math.random() - 0.5
        ).slice(0, 32)
        currentTime = INITIAL_TIME

        $time.textContent = currentTime

        $paragraph.innerHTML = words.map((word, index) => {
            const letters = word.split('')

            return `<x-word>
                ${letters.map(letter => `<x-letter>${letter}</x-letter>`)
                .join('')
                }
                </x-word>
                `
        }).join('')
        
        const $firstword = $paragraph.querySelector('x-word')
        $firstword.classList.add('active')
        $firstword.querySelector('x-letter').classList.add('active')

        const intervalId = setInterval(() =>{
            currentTime--
            $time.textContent = currentTime

            if (currentTime ===0){
                clearInterval(intervalId)
                gameOver()
            }
        }, 1000)
    }
    function initEvents() {
        document.addEventListener('keydown', () =>{
            $input.focus()
        })
        $input.addEventListener('keydown', onKeyDown)
        $input.addEventListener('keyup', onKeyUp)
    }

    function onKeyDown(event) {
        const $currentWord = $paragraph.querySelector('x-word.active')
        const $currentLetter = $currentWord.querySelector('x-letter.active')

        const { key } = event
        if (key === ' '){

            event.preventDefault()

            const $nextWord = $currentWord.nextElementSibling
            const $nextLetter = $nextWord.querySelector('x-letter')

            $currentWord.classList.remove('active','marked')
            $currentLetter.classList.remove('active')

            $nextWord.classList.add('active')
            $nextLetter.classList.add('active')

            $input.value = ''

            const hasMissedLetters= $currentWord
            .querySelectorAll('x-letter:not(.correct)').length > 0

            const classToAdd = hasMissedLetters ? 'marked' : 'correct'
            $currentWord.classList.add(classToAdd)

            return
        }

        if (key === 'Backspace'){
            const $prevWord = $currentWord.previousElementSibling
            const $prevLetter = $currentLetter.previousElementSibling

            if(!$prevWord && !$prevLetter) {

                event.preventDefault()
                return
            }


            const $wordMarked = $paragraph.querySelector('x-word.marked')
            if ($wordMarked && !$prevLetter){
                event.preventDefault()
                $prevWord.classList.remove('marked')
                $prevWord.classList.add('active')

                const $letterToGo = $prevWord.querySelector('x-letter:last-child')

                $currentLetter.classList.remove('active')
                $letterToGo.classList.add('active')

                $input.value = [
                    ...$prevWord.querySelectorAll('x-letter.correct, x-letter.incorrect')
                ].map($el => {
                    return $el.classList.contains('correct') ? $el.innerText : '*'
                })
                    .join('')
            }
        }
    }
    function onKeyUp() {
        //We need to recover current elements
        const $currentWord = $paragraph.querySelector('x-word.active')
        const $currentLetter = $currentWord.querySelector('x-letter.active')

        const currentWord = $currentWord.innerText.trim()
        $input.maxLength = currentWord.length
        // console.log({value: $input.value, currentWord})

        const $allLetters = $currentWord.querySelectorAll('x-letter')

        $allLetters.forEach($letter => $letter.classList.remove('correct', 'incorrect'))

        $input.value.split('').forEach((char, index) =>{
            const $letter = $allLetters[index]
            const letterToCheck = currentWord[index]

            const isCorrect = char === letterToCheck
            const letterClass = isCorrect ? 'correct' : 'incorrect'
            $letter.classList.add(letterClass)
        })

        $currentLetter.classList.remove('active', 'is-last')
        const inputLength = $input.value.length
        const $nextActiveLetter = $allLetters[inputLength]
        
        if($nextActiveLetter){
            $nextActiveLetter.classList.add('active')
        } else {
            $currentLetter.classList.add('active', 'is-last')
        }
    }

    function gameOver() {
        console.log('game over')
    }
</script>
<!-- I know tags like x-word or x-letter do not exist, but since HTML is gonna treat them as spans I've
decided to use them for better legibility, following midudev's advice in the tutorial.
They're simple Custom Elements-->
